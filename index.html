<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moonsh0p âœ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Exo+2:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    /* --- Keyframes for Animations --- */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Keyframe for the new parallax stars background */
    @keyframes move-twink-back {
        from { background-position: 0 0; }
        to { background-position: -10000px 5000px; }
    }

    @keyframes breathe {
      0%, 100% {
        text-shadow:
          0 0 25px rgba(0, 220, 255, 0.5),
          0 0 15px rgba(173, 216, 230, 0.6),
          2px 2px 3px rgba(10, 4, 31, 0.8);
      }
      50% {
        text-shadow:
          0 0 30px rgba(162, 123, 255, 0.5), /* Shift color slightly */
          0 0 20px rgba(200, 220, 255, 0.6),
          2px 2px 3px rgba(10, 4, 31, 0.8);
      }
    }

    /* --- General Body & Background Styling --- */
    body {
      font-family: 'Exo 2', sans-serif;
      color: #e0e0e0;
      background-color: #0a041f;
      background-image: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
      
      /* Responsive sizing */
      width: 95%;
      max-width: 550px;
      min-height: 100vh;
      margin: 2em auto;
      padding: 2em;
      
      overflow-x: hidden; /* Prevent horizontal scroll on mobile */
      position: relative;
    }
    
    /* --- New Animated Starry Background --- */
    .stars, .twinkling {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      display: block;
      z-index: -2;
    }

    .stars {
      background: #000 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAAXNSR0IArs4c6QAAAVZJREFUeF7t1sFpFFEAhem9805qCAgqFlYQFFSUgkWsoCgIioqNm7koCIIi8cZ7f/C6+ZbkZueWu9k7s5v9fn4955yZmV3sZz8A8JcBABwEAMAhAIAjAIAzAAAzAICzAAAzAMBcAAAMwFwAAAzAXQAAAMAdAAAMwB0AAAzAewAAAMA9AAAMwD0AAAzAggAAwIUAAECFAAABAAEtAIAjAQCAIwAAswAAswAAswAAswAAswAAswAAswAAswAAgwAAgwAAgwAAgwAAgwAAgwAAgwAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAMgAAsgAAsgAAsgAAsgAAsgAAsgAAsgAAsgAAsgAAIwAAIwAAIwAAIwAAIwAAIwAAIwAAsQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQCAgwAAuAAAwA0AAMwBACwBAACA5wAAgH8BADAAAFwEAMARAGD+A/y8ATnoXy2sAAAAAElFTkSuQmCC) repeat top center;
    }

    .twinkling {
      background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAAXNSR0IArs4c6QAAAVVJREFUeF7t1rFpBEEQheE5wgSpkigpgkgkKmmkSCoJpBAJpRIJpahESpFIJBIJpVIpUjzu+M7uZnZnl3s7837OP57d/d7Nmd3NfgDm5w8AADgIAIAjAIAjAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAADMAACDAAA4CADgIAAAjgAAjgAAmAEA3AMAYB4AAHAAAIAjAAAwDwCAeQAAwB0AwB0AAOYBAOYBAIADAAAwAAA4CADgIAAAjgAAzAEAAAQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQAAgQCAgIAAIAEAgIAAIAEAgIAAIAEAgIAAIAEAgIAAIAEAgIAAIAEAgIAAIAEAgIDAPwAATAAA4ACAYz8A8gcAAMB9AADADQDAGQCAmQAA2AIAcBcAYC4AAAbg/gG48AG9b4Y1GAAAAABJRU5ErkJggg==) repeat top center;
      animation: move-twink-back 200s linear infinite;
    }


    /* --- Typography --- */
    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 32px;
      font-weight: 800;
      color: #eaf6ff; /* A cool, solid off-white */
      margin-bottom: 25px;
      text-align: center;
      text-shadow:
        0 0 25px rgba(0, 220, 255, 0.5),
        0 0 15px rgba(173, 216, 230, 0.6),
        2px 2px 3px rgba(10, 4, 31, 0.8);
      animation: breathe 8s ease-in-out infinite;
      transition: text-shadow 0.4s ease; /* Smooth transition for hover */
    }
    
    h1:hover {
      text-shadow:
        0 0 30px rgba(0, 220, 255, 0.7),
        0 0 20px rgba(173, 216, 230, 0.8),
        2px 2px 3px rgba(10, 4, 31, 0.8);
    }

    /* --- Main Container & Glassmorphism Effect --- */
    #authSection, #welcomeSection, #mainContent {
      background: rgba(26, 19, 52, 0.4);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(162, 123, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px 0 rgba(10, 4, 31, 0.37);
      transition: opacity 0.5s ease, transform 0.5s ease;
      display: none; /* Hidden by default */
    }

    .section-visible { display: block !important; animation: fadeIn 0.6s ease-out forwards; }
    .hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }

    /* --- Buttons & Inputs --- */
    .btn {
      font-family: 'Orbitron', sans-serif;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      padding: 10px 15px;
      transition: all 0.3s ease;
      background-size: 200% 100%;
      color: white;
      letter-spacing: 1px;
    }
    
    .btn-primary { background-image: linear-gradient(to right, #6a11cb 0%, #2575fc 51%, #6a11cb 100%); }
    .btn-success { background-image: linear-gradient(to right, #11cb6a 0%, #259cfc 51%, #11cb6a 100%); }
    .btn-secondary { background-image: linear-gradient(to right, #434343 0%, #000000 51%, #434343 100%); }
    .btn-danger { background-image: linear-gradient(to right, #cb113e 0%, #fc2525 51%, #cb113e 100%); }

    .btn:hover {
      background-position: right center;
      transform: scale(1.05) translateY(-2px);
      box-shadow: 0 0 15px rgba(162, 123, 255, 0.5);
      color: #fff;
    }
    .btn:active { transform: scale(0.98); }

    .form-control, .form-select {
        background-color: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(162, 123, 255, 0.5);
        color: #fff;
        border-radius: 8px;
    }
    .form-control::placeholder { color: #aaa; }
    .form-control:focus, .form-select:focus {
        background-color: rgba(0, 0, 0, 0.4);
        color: #fff;
        box-shadow: 0 0 10px rgba(162, 123, 255, 0.7);
        border-color: #a27bff;
    }
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23a27bff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }

    /* --- Wishlist Items --- */
    #wishlistContainer { max-height: 280px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #a27bff #0a041f;}
    .list-group-item {
        background: rgba(40, 30, 80, 0.3);
        border: 1px solid rgba(162, 123, 255, 0.2);
        margin-bottom: 8px;
        border-radius: 10px;
        transition: all 0.4s ease;
        opacity: 0;
        transform: translateX(-20px);
    }
    .list-group-item.show {
        opacity: 1;
        transform: translateX(0);
    }
    .list-group-item:hover {
      background: rgba(60, 50, 120, 0.5);
      border-color: #a27bff;
      transform: scale(1.02);
    }
    .title {
      font-size: 14px;
      font-weight: 500;
      color: #f0f0f0;
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #status, #authSection p, #welcomeMessage { color: #c0c0c0; text-align: center; }

    /* --- Modals --- */
    .modal-content {
      background: rgba(16, 8, 47, 0.8);
      border-radius: 15px;
      border: 1px solid rgba(162, 123, 255, 0.5);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      box-shadow: 0 8px 32px 0 rgba(10, 4, 31, 0.5);
    }
    .modal-header { border-bottom: 1px solid rgba(162, 123, 255, 0.3); }
    .modal-footer { border-top: 1px solid rgba(162, 123, 255, 0.3); }
    .modal-title, .modal-header .btn-close { color: #fff; }
    .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
    .modal.fade .modal-dialog { transition: transform .4s ease-out; transform: translateY(-50px) scale(0.9); }
    .modal.show .modal-dialog { transform: none; }

    /* --- Scrollbar & Mobile/Responsive Adjustments --- */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1b2735; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #a27bff; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #00f5ff; }

    @media (max-width: 500px) {
        body {
            padding: 1em;
            margin: 0;
            width: 100%;
            max-width: 100%;
            min-height: 100svh; /* More accurate viewport height for mobile */
            border-radius: 0;
        }
        h1 {
            font-size: 28px;
        }
        .title {
            max-width: 120px; /* Adjust for smaller screens */
        }
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="twinkling"></div>

  <h1 class="text-center">Moonsh0p</h1>

  <div id="authSection">
    <p>
      Welcome to <strong>Moonsh0p</strong>! Save products from any page to your wishlists.<br>
      Please log in or register to get started.
    </p>
    <div class="d-grid">
      <button id="loginButton" class="btn btn-primary mb-3">Login / Register</button>
    </div>
  </div>

  <div id="welcomeSection" class="hidden">
    <p id="welcomeMessage" class="fs-5"></p>
    <button id="logoutButton" class="btn btn-secondary mb-3 w-100">Logout</button>
  </div>

  <div id="mainContent" class="hidden">
    <div class="mb-3">
      <select id="wishlistSelect" class="form-select">
        <option value="" disabled selected>Select a Wishlist</option>
      </select>
    </div>
    <div class="d-grid gap-2 mb-3">
      <button id="newWishlistButton" class="btn btn-success">Create New Wishlist</button>
      <button id="addButton" class="btn btn-primary">Add Item to Wishlist</button>
      <button id="shareWishlistButton" class="btn btn-secondary">Share Wishlist</button>
    </div>

    <div id="wishlistContainer" class="list-group">
      </div>

    <div id="paginationContainer">
      </div>

    <p id="status" class="mt-3">Loading wishlist...</p>
  </div>

  <div class="modal fade" id="newWishlistModal" tabindex="-1" aria-labelledby="newWishlistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Wishlist</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newWishlistName" class="form-label">Wishlist Name</label>
            <input type="text" id="newWishlistName" class="form-control" placeholder="e.g., Starship Parts">
          </div>
          <button type="button" id="saveWishlistButton" class="btn btn-primary w-100">Save Wishlist</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login or Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="usernameInput" class="form-label">Username</label>
            <input type="text" id="usernameInput" class="form-control" placeholder="Enter username">
          </div>
          <div class="mb-3">
            <label for="passwordInput" class="form-label">Password</label>
            <input type="password" id="passwordInput" class="form-control" placeholder="Enter password">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="loginModalButton" class="btn btn-primary">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Login</span>
          </button>
          <button type="button" id="registerModalButton" class="btn btn-success">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            <span class="button-text">Register</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="itemTitle" class="form-label">Title</label>
            <input type="text" id="itemTitle" class="form-control" placeholder="Enter item title">
          </div>
          <div class="mb-3">
            <label for="itemImage" class="form-label">Image URL</label>
            <input type="text" id="itemImage" class="form-control" placeholder="Enter image URL">
          </div>
          <div class="mb-3">
            <label for="itemURL" class="form-label">Product URL</label>
            <input type="text" id="itemURL" class="form-control" placeholder="Enter product URL">
          </div>
          <button type="button" id="saveItemButton" class="btn btn-primary w-100">Add Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global variables for pagination
    let currentPage = 1;
    const itemsPerPage = 5;

    // API Base URL
    const BASE_URL = 'https://ranfysvalle02--wishlist-api-fastapi-app.modal.run';

    // API Endpoints
    const ENDPOINTS = {
      register: `${BASE_URL}/register`,
      authenticate: `${BASE_URL}/authenticate`,
      refresh: `${BASE_URL}/refresh`,
      getWishlists: `${BASE_URL}/get_wishlists`,
      createWishlist: `${BASE_URL}/create_wishlist`,
      viewItems: `${BASE_URL}/view_items`,
      addItem: `${BASE_URL}/add_item`,
      removeItem: `${BASE_URL}/remove_item`,
      viewList: `${BASE_URL}/view_list`,
    };

    // Authentication tokens
    let accessToken = '';
    let refreshToken = '';

    // --- Helper Functions ---

    // Helper function to manage button loading state
    function setButtonLoading(button, isLoading) {
      const spinner = button.querySelector('.spinner-border');
      const text = button.querySelector('.button-text');
      if (isLoading) {
        button.disabled = true;
        spinner.classList.remove('d-none');
        if (text) text.style.opacity = '0';
      } else {
        button.disabled = false;
        spinner.classList.add('d-none');
        if (text) text.style.opacity = '1';
      }
    }

    function storeTokens(access, refresh) {
      accessToken = access;
      refreshToken = refresh;
      localStorage.setItem('accessToken', accessToken);
      localStorage.setItem('refreshToken', refreshToken);
    }

    function loadTokens() {
      accessToken = localStorage.getItem('accessToken') || '';
      refreshToken = localStorage.getItem('refreshToken') || '';
    }

    function clearTokens() {
      accessToken = '';
      refreshToken = '';
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
    }

    function isAuthenticated() {
      return !!accessToken;
    }

    function getCurrentWishlist() {
      const select = document.getElementById('wishlistSelect');
      const selectedIndex = select.selectedIndex;
      if (selectedIndex < 1) {
        return { wishlistName: '', wishlistId: '' };
      }
      const selectedOption = select.options[selectedIndex];
      return { wishlistName: selectedOption.text, wishlistId: selectedOption.value };
    }

    async function authenticatedFetch(url, options = {}) {
      if (!options.headers) options.headers = {};
      options.headers['Authorization'] = `Bearer ${accessToken}`;
      let response = await fetch(url, options);
      if (response.status === 401) {
        const refreshed = await refreshAccessToken();
        if (refreshed) {
          options.headers['Authorization'] = `Bearer ${accessToken}`;
          response = await fetch(url, options);
        } else {
          alert('Session expired. Please log in again.');
          logout();
          throw new Error('Authentication required');
        }
      }
      return response;
    }

    async function refreshAccessToken() {
      if (!refreshToken) return false;
      try {
        const response = await fetch(ENDPOINTS.refresh, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh_token: refreshToken }),
        });
        if (response.ok) {
          const data = await response.json();
          storeTokens(data.access_token, data.refresh_token);
          return true;
        }
        clearTokens();
        return false;
      } catch (error) {
        console.error('Error refreshing token:', error);
        clearTokens();
        return false;
      }
    }

    // --- Authentication Functions ---
    async function register(username, password) {
      try {
        const response = await fetch(ENDPOINTS.register, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (response.ok) {
          alert('Registration successful! You can now log in.');
          return true;
        }
        const errorData = await response.json();
        alert('Registration failed: ' + (errorData.detail || 'Unknown error'));
        return false;
      } catch (error) {
        console.error('Error registering:', error);
        alert('Error registering.');
        return false;
      }
    }

    async function login(username, password) {
      try {
        const response = await fetch(ENDPOINTS.authenticate, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (response.ok) {
          const data = await response.json();
          storeTokens(data.access_token, data.refresh_token);
          localStorage.setItem('username', username);
          return true;
        }
        const errorData = await response.json();
        alert('Login failed: ' + (errorData.detail || 'Unknown error'));
        return false;
      } catch (error) {
        console.error('Error logging in:', error);
        alert('Error logging in.');
        return false;
      }
    }

    function logout() {
      clearTokens();
      localStorage.removeItem('username');
      showSection(document.getElementById('authSection'));
      hideSection(document.getElementById('welcomeSection'));
      hideSection(document.getElementById('mainContent'));
      document.getElementById('wishlistSelect').innerHTML = '';
      document.getElementById('wishlistContainer').innerHTML = '';
      document.getElementById('status').textContent = 'Please log in to view your wishlists.';
    }

    // --- API Functions ---
    async function getWishlists() {
      try {
        const response = await authenticatedFetch(ENDPOINTS.getWishlists);
        return response.ok ? (await response.json()).wishlists : [];
      } catch (error) {
        console.error('Error fetching wishlists:', error);
        return [];
      }
    }

    async function createWishlist(wishlistName) {
      try {
        const response = await authenticatedFetch(ENDPOINTS.createWishlist, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wishlist_name: wishlistName }),
        });
        if (response.ok) {
          return { success: true, wishlistId: (await response.json()).wishlist_id };
        }
        return { success: false, error: (await response.json()).detail || 'Unknown error' };
      } catch (error) {
        return { success: false, error: error.message };
      }
    }

    async function removeItem(itemId, itemElement) {
      itemElement.style.cssText = 'opacity:0; transform:translateX(50px); height:0; padding:0; margin:0; border:none;';
      try {
        const response = await authenticatedFetch(`${ENDPOINTS.removeItem}/${encodeURIComponent(itemId)}`, { method: 'DELETE' });
        if (!response.ok) {
          alert('Failed to remove item: ' + ((await response.json()).detail || 'Unknown error'));
          itemElement.style.cssText = '';
        } else {
          setTimeout(() => displayWishlist(), 400);
        }
      } catch (error) {
        console.error('Error removing item:', error);
        alert('Error removing item.');
        itemElement.style.cssText = '';
      }
    }

    async function getWishlistItems(wishlist) {
      try {
        const response = await authenticatedFetch(`${ENDPOINTS.viewItems}?wishlist_id=${encodeURIComponent(wishlist.wishlistId)}`);
        return response.ok ? (await response.json()).items || [] : [];
      } catch (error) {
        console.error('Error fetching wishlist items:', error);
        return [];
      }
    }

    async function loadWishlists() {
      const wishlistArray = await getWishlists();
      const select = document.getElementById('wishlistSelect');
      select.innerHTML = '<option value="" disabled selected>Select a Wishlist</option>';
      wishlistArray.forEach((wishlist) => {
        select.innerHTML += `<option value="${wishlist.id}">${wishlist.wishlist_name}</option>`;
      });
      if (wishlistArray.length > 0) {
        select.value = wishlistArray[0].id;
        await displayWishlist();
      }
      updateShareButtonState();
    }

    function updateShareButtonState() {
      document.getElementById('shareWishlistButton').disabled = !getCurrentWishlist().wishlistId;
    }

    async function displayWishlist() {
      const wishlistContainer = document.getElementById('wishlistContainer');
      const status = document.getElementById('status');
      const paginationContainer = document.getElementById('paginationContainer');
      wishlistContainer.innerHTML = '';
      paginationContainer.innerHTML = '';
      const currentWishlist = getCurrentWishlist();
      if (!currentWishlist.wishlistId) {
        status.textContent = 'Select a wishlist to view items.';
        return;
      }
      const items = await getWishlistItems(currentWishlist);
      if (!items || items.length === 0) {
        status.textContent = 'Your wishlist is empty.';
      } else {
        status.textContent = '';
        const totalPages = Math.ceil(items.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        const itemsToDisplay = items.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
        itemsToDisplay.forEach((item, index) => {
          const itemCard = document.createElement('div');
          itemCard.className = 'list-group-item d-flex align-items-center justify-content-between';
          itemCard.innerHTML = `
            <a href="${item.url || '#'}" target="_blank" class="d-flex align-items-center text-decoration-none text-dark flex-grow-1">
              <img src="${item.image || 'https://via.placeholder.com/60'}" alt="${item.title}" class="rounded me-3" style="width:60px; height:60px; object-fit:cover;">
              <div class="title" title="${item.title}">${item.title}</div>
            </a>
            <button class="btn btn-sm btn-danger remove-btn">Remove</button>
          `;
          wishlistContainer.appendChild(itemCard);
          itemCard.querySelector('.remove-btn').addEventListener('click', (e) => {
            e.stopPropagation(); e.preventDefault();
            removeItem(item.id, itemCard);
          });
          setTimeout(() => itemCard.classList.add('show'), index * 100);
        });
        if (totalPages > 1) {
          const paginationControls = document.createElement('div');
          paginationControls.className = 'd-flex justify-content-center align-items-center mt-3';
          const prevButton = document.createElement('button');
          prevButton.className = 'btn btn-secondary btn-sm me-2';
          prevButton.textContent = 'Previous';
          prevButton.disabled = currentPage === 1;
          prevButton.addEventListener('click', () => { currentPage--; displayWishlist(); });
          const nextButton = document.createElement('button');
          nextButton.className = 'btn btn-secondary btn-sm ms-2';
          nextButton.textContent = 'Next';
          nextButton.disabled = currentPage === totalPages;
          nextButton.addEventListener('click', () => { currentPage++; displayWishlist(); });
          const pageInfo = document.createElement('span');
          pageInfo.className = 'align-self-center mx-2';
          pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          paginationControls.appendChild(prevButton);
          paginationControls.appendChild(pageInfo);
          paginationControls.appendChild(nextButton);
          paginationContainer.appendChild(paginationControls);
        }
      }
    }

    function showSection(section) {
      section.classList.remove('hidden');
      section.classList.add('section-visible');
    }

    function hideSection(section) {
      section.classList.add('hidden');
      section.classList.remove('section-visible');
    }

    // --- Event Listeners ---
    document.getElementById('addButton').addEventListener('click', () => {
      if (!isAuthenticated()) { alert('Please log in to add items.'); return; }
      const currentWishlist = getCurrentWishlist();
      if (!currentWishlist.wishlistId) { alert('Please select a wishlist first.'); return; }
      new bootstrap.Modal(document.getElementById('addItemModal')).show();
    });

    document.getElementById('saveItemButton').addEventListener('click', async () => {
      const itemTitle = document.getElementById('itemTitle').value.trim();
      const itemImage = document.getElementById('itemImage').value.trim();
      const itemURL = document.getElementById('itemURL').value.trim();
      if (!itemTitle) { alert('Please enter the item title.'); return; }
      const currentWishlist = getCurrentWishlist();
      if (!currentWishlist.wishlistId) { alert('Please select a wishlist.'); return; }
      const itemData = { wishlist_id: currentWishlist.wishlistId, title: itemTitle, image: itemImage, url: itemURL };
      try {
        const response = await authenticatedFetch(ENDPOINTS.addItem, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(itemData),
        });
        if (!response.ok) {
          alert('Failed to add item: ' + ((await response.json()).detail || 'Unknown error'));
        } else {
          currentPage = 1;
          await displayWishlist();
          alert('Item added to "' + currentWishlist.wishlistName + '"!');
          bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
          document.getElementById('itemTitle').value = '';
          document.getElementById('itemImage').value = '';
          document.getElementById('itemURL').value = '';
        }
      } catch (error) {
        alert('Error adding item.');
      }
    });

    document.getElementById('wishlistSelect').addEventListener('change', async () => {
      currentPage = 1;
      await displayWishlist();
      updateShareButtonState();
    });

    document.getElementById('newWishlistButton').addEventListener('click', () => {
      if (!isAuthenticated()) { alert('Please log in to create wishlists.'); return; }
      new bootstrap.Modal(document.getElementById('newWishlistModal')).show();
    });

    document.getElementById('saveWishlistButton').addEventListener('click', async () => {
      const wishlistNameInput = document.getElementById('newWishlistName');
      const wishlistName = wishlistNameInput.value.trim();
      if (wishlistName) {
        const result = await createWishlist(wishlistName);
        if (result.success) {
          await loadWishlists();
          document.getElementById('wishlistSelect').value = result.wishlistId;
          wishlistNameInput.value = '';
          bootstrap.Modal.getInstance(document.getElementById('newWishlistModal')).hide();
          currentPage = 1;
          await displayWishlist();
          updateShareButtonState();
          alert(`Wishlist "${wishlistName}" created!`);
        } else {
          alert(`Failed to create wishlist: ${result.error}`);
        }
      } else {
        alert('Please enter a name for your wishlist.');
      }
    });

    document.getElementById('shareWishlistButton').addEventListener('click', () => {
      const currentWishlist = getCurrentWishlist();
      if (!currentWishlist.wishlistId) return alert('Please select a wishlist to share.');
      const shareableLink = `${ENDPOINTS.viewList}/${currentWishlist.wishlistId}`;
      navigator.clipboard.writeText(shareableLink).then(() => {
        alert(`Shareable link copied to clipboard:\n${shareableLink}`);
      }).catch(() => alert(`Shareable link:\n${shareableLink}`));
    });

    document.getElementById('loginButton').addEventListener('click', () => {
      new bootstrap.Modal(document.getElementById('authModal')).show();
    });

    document.getElementById('logoutButton').addEventListener('click', logout);

    document.getElementById('loginModalButton').addEventListener('click', async (event) => {
      const loginButton = event.currentTarget;
      const username = document.getElementById('usernameInput').value.trim();
      const password = document.getElementById('passwordInput').value;

      if (!username || !password) return alert('Please enter username and password.');

      setButtonLoading(loginButton, true);
      try {
        const success = await login(username, password);
        if (success) {
          bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
          hideSection(document.getElementById('authSection'));
          showSection(document.getElementById('welcomeSection'));
          showSection(document.getElementById('mainContent'));
          document.getElementById('welcomeMessage').textContent = `Welcome back, ${username}!`;
          document.getElementById('usernameInput').value = '';
          document.getElementById('passwordInput').value = '';
          await loadWishlists();
        }
      } finally {
        setButtonLoading(loginButton, false);
      }
    });

    document.getElementById('registerModalButton').addEventListener('click', async (event) => {
      const registerButton = event.currentTarget;
      const username = document.getElementById('usernameInput').value.trim();
      const password = document.getElementById('passwordInput').value;

      if (!username || !password) return alert('Please enter username and password.');
      
      setButtonLoading(registerButton, true);
      try {
        const success = await register(username, password);
        if (success) {
          document.getElementById('usernameInput').value = '';
          document.getElementById('passwordInput').value = '';
        }
      } finally {
        setButtonLoading(registerButton, false);
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      loadTokens();
      if (isAuthenticated()) {
        hideSection(document.getElementById('authSection'));
        showSection(document.getElementById('welcomeSection'));
        showSection(document.getElementById('mainContent'));
        document.getElementById('welcomeMessage').textContent = `Welcome back, ${localStorage.getItem('username') || 'User'}!`;
        await loadWishlists();
      } else {
        showSection(document.getElementById('authSection'));
        hideSection(document.getElementById('welcomeSection'));
        hideSection(document.getElementById('mainContent'));
        document.getElementById('status').textContent = 'Please log in to view your wishlists.';
      }
      updateShareButtonState();
    });
  </script>
</body>
</html>
